<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Attendance Reports</title>
<link rel="stylesheet" href="style.css">
<style>
body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background-color: #1A202C;
  color: #E2E8F0;
  margin: 0;
}

.report-container {
  margin-left: 260px;
  padding: 40px;
  position: relative;
  z-index: 1;
}

.filters {
  background: rgba(26,32,44,0.95);
  border-radius: 20px;
  padding: 20px;
  margin-bottom: 30px;
  display: flex;
  gap: 20px;
  flex-wrap: wrap;
  position: relative;
  z-index: 10;
  pointer-events: auto;
}

.filter-group {
  display: flex;
  flex-direction: column;
}

.filter-group label {
  color: #E2E8F0;
  margin-bottom: 5px;
  font-weight: 500;
}

.filter-group select,
.filter-group input {
  padding: 8px;
  border-radius: 8px;
  border: 1px solid rgba(255,255,255,0.3);
  background: rgba(255,255,255,0.05);
  color: #fff;
  cursor: pointer;
}

.summary-stats {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 20px;
  margin-bottom: 30px;
}

.stat-card {
  background: rgba(127,156,245,0.15);
  border-radius: 15px;
  padding: 20px;
  text-align: center;
}

.stat-number {
  font-size: 32px;
  font-weight: 700;
  color: #7F9CF5;
}

.stat-label {
  color: #A0AEC0;
  margin-top: 8px;
}

.export-btn {
  background: rgba(72,187,120,0.2);
  color: #48BB78;
  border: none;
  padding: 12px 24px;
  border-radius: 12px;
  cursor: pointer;
  font-weight: 600;
  margin-bottom: 20px;
}

.export-btn:hover {
  background: rgba(72,187,120,0.3);
}

table {
  width: 100%;
  border-collapse: collapse;
  margin: 15px 0;
}

table th,
table td {
  padding: 12px;
  border-bottom: 1px solid rgba(255,255,255,0.1);
  text-align: left;
}

table th {
  background: rgba(127,156,245,0.2);
  color: #fff;
  font-weight: 600;
}

table td {
  color: #E2E8F0;
}

.status-present {
  background: rgba(72,187,120,0.2);
  color: #48BB78;
  padding: 4px 8px;
  border-radius: 8px;
}

.status-absent {
  background: rgba(245,101,101,0.2);
  color: #F56565;
  padding: 4px 8px;
  border-radius: 8px;
}

.sidebar {
  position: fixed;
  width: 260px;
  height: 100%;
  background: #2D3748;
  padding: 20px;
  z-index: 5;
}

.sidebar h2 {
  margin-top: 0;
  color: #fff;
}

.sidebar ul {
  list-style: none;
  padding: 0;
  margin-top: 20px;
}

.sidebar li {
  margin: 15px 0;
}

.sidebar a {
  color: #E2E8F0;
  text-decoration: none;
  display: block;
  padding: 5px 0;
}

.sidebar a.active {
  color: #7F9CF5;
  font-weight: bold;
}

.logout-btn {
  margin-top: 20px;
  padding: 10px;
  width: 100%;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  background: #E53E3E;
  color: #fff;
}

.logout-btn:hover {
  background: #C53030;
}

.card {
  background: rgba(26,32,44,0.85);
  border-radius: 15px;
  padding: 20px;
  margin-bottom: 20px;
}
</style>
</head>
<body>

<div class="sidebar">
  <h2>Dashboard</h2>
  <ul>
    <li><a href="lecturer.html">Dashboard</a></li>
    <li><a href="report.html" class="active">Attendance Report</a></li>
  </ul>
  <button class="logout-btn" onclick="window.location.href='index.html'">Logout</button>
</div>

<div class="report-container">
  <div class="dashboard-header">
    <h1>Attendance Reports</h1>
    <p id="lecturerInfo">Loading...</p>
  </div>

  <div class="filters">
    <div class="filter-group">
      <label for="moduleFilter">Module:</label>
      <select id="moduleFilter">
        <option value="">All Modules</option>
        <option value="Default Module">Default Module</option>
      </select>
    </div>
    <div class="filter-group">
      <label for="dateFilter">Date:</label>
      <input type="date" id="dateFilter">
    </div>
    <div class="filter-group">
      <label for="statusFilter">Status:</label>
      <select id="statusFilter">
        <option value="">All Status</option>
        <option value="Present">Present</option>
        <option value="Absent">Absent</option>
      </select>
    </div>
  </div>

  <button class="export-btn" onclick="exportToCSV()">Export to CSV</button>

  <div id="summaryStats" class="summary-stats" style="display:none;">
    <div class="stat-card">
      <div class="stat-number" id="totalPresent">0</div>
      <div class="stat-label">Total Present</div>
    </div>
    <div class="stat-card">
      <div class="stat-number" id="totalAbsent">0</div>
      <div class="stat-label">Total Absent</div>
    </div>
    <div class="stat-card">
      <div class="stat-number" id="totalSessions">0</div>
      <div class="stat-label">Total Records</div>
    </div>
    <div class="stat-card">
      <div class="stat-number" id="avgAttendance">0%</div>
      <div class="stat-label">Avg Attendance</div>
    </div>
  </div>

  <div id="reportsContainer">
    <div class="card"><p style="text-align:center; color:#A0AEC0;">Loading reports...</p></div>
  </div>
</div>

<script>
const moduleFilter = document.getElementById('moduleFilter');
const dateFilter = document.getElementById('dateFilter');
const statusFilter = document.getElementById('statusFilter');
const reportsContainer = document.getElementById('reportsContainer');
const lecturerInfo = document.getElementById('lecturerInfo');
const summaryStats = document.getElementById('summaryStats');

let allReports = [];
let filteredReports = [];

const API_URL = "http://localhost:3000/api";

document.addEventListener('DOMContentLoaded', async () => {
  const lecturerName = sessionStorage.getItem('lecturerName') || "Default Lecturer";
  lecturerInfo.textContent = `Reports for: ${lecturerName}`;

  moduleFilter.addEventListener('change', filterReports);
  dateFilter.addEventListener('change', filterReports);
  statusFilter.addEventListener('change', filterReports);

  await loadReports();
});

async function loadReports() {
  try {
    const res = await fetch(`${API_URL}/students`);
    if (!res.ok) throw new Error("Failed to fetch students");

    const students = await res.json();

    allReports = students.map(s => ({
      name: s.name,
      student_no: s.id,
      status: s.attendance ? "Present" : "Absent",
      time_recorded: s.timestamp ? new Date(s.timestamp).toLocaleString() : "-",
      module: "Default Module",
      date: s.timestamp ? s.timestamp.split("T")[0] : new Date().toISOString().split("T")[0]
    }));

    filteredReports = [...allReports];

    if (!allReports.length) {
      reportsContainer.innerHTML = `<div class="card"><p style="text-align:center; color:#A0AEC0;">No attendance records found.</p></div>`;
      summaryStats.style.display = 'none';
      return;
    }

    displayReports();
    updateSummaryStats();
  } catch (err) {
    console.error("Failed to load reports:", err);
    reportsContainer.innerHTML = `<div class="card"><p style="text-align:center; color:#F56565;">Error loading reports. Please try again.</p></div>`;
  }
}

function displayReports() {
  if (!filteredReports.length) {
    reportsContainer.innerHTML = `<div class="card"><p style="text-align:center; color:#A0AEC0;">No records match the filters.</p></div>`;
    summaryStats.style.display = 'none';
    return;
  }

  let html = `<div class="card">
               <table>
                 <thead>
                   <tr>
                     <th>Student Name</th>
                     <th>Student No</th>
                     <th>Status</th>
                     <th>Time</th>
                   </tr>
                 </thead>
                 <tbody>`;

  filteredReports.forEach(r => {
    const statusClass = r.status === "Present" ? "status-present" : "status-absent";
    html += `<tr>
               <td>${r.name || 'N/A'}</td>
               <td>${r.student_no || 'N/A'}</td>
               <td><span class="${statusClass}">${r.status}</span></td>
               <td>${r.time_recorded}</td>
             </tr>`;
  });

  html += `</tbody></table></div>`;
  reportsContainer.innerHTML = html;
  summaryStats.style.display = 'grid';
}

function filterReports() {
  const moduleVal = moduleFilter.value;
  const dateVal = dateFilter.value;
  const statusVal = statusFilter.value;

  filteredReports = allReports.filter(r => {
    return (!moduleVal || r.module === moduleVal) &&
           (!dateVal || r.date === dateVal) &&
           (!statusVal || r.status === statusVal);
  });

  displayReports();
  updateSummaryStats();
}

function updateSummaryStats() {
  const total = filteredReports.length;
  const present = filteredReports.filter(r => r.status === "Present").length;
  const absent = total - present;

  document.getElementById('totalPresent').textContent = present;
  document.getElementById('totalAbsent').textContent = absent;
  document.getElementById('totalSessions').textContent = total;
  document.getElementById('avgAttendance').textContent = total ? ((present/total)*100).toFixed(0)+'%' : '0%';
}

function exportToCSV() {
  if (!filteredReports.length) return alert("No data to export.");

  let csv = "Module,Date,Student Name,Student No,Status,Time\n";
  filteredReports.forEach(r => {
    csv += `${r.module},${r.date},${r.name},${r.student_no},${r.status},${r.time_recorded}\n`;
  });

  const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = `attendance_report_${new Date().toISOString().split('T')[0]}.csv`;
  link.click();
}
</script>
</body>
</html>
