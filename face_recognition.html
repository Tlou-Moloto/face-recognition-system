<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Face Recognition - Attendance</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    .camera-container { display:flex; justify-content:center; align-items:center; flex-direction:column; min-height:60vh; padding:20px; }
    .camera-box { position:relative; border:3px solid #7F9CF5; border-radius:20px; overflow:hidden; margin-bottom:30px; box-shadow:0 8px 32px rgba(127,156,245,.3); }
    #videoElement { width:640px; height:480px; object-fit:cover; display:block; background:#000; }
    #canvas { position:absolute; top:0; left:0; }
    .status-indicator { padding:12px 16px; border-radius:10px; font-weight:600; margin:12px 0; text-align:center; }
    .status-scanning { background:rgba(127,156,245,.2); color:#7F9CF5; border:1px solid rgba(127,156,245,.3); }
    .status-success { background:rgba(72,187,120,.2); color:#48BB78; border:1px solid rgba(72,187,120,.3); }
    .status-error { background:rgba(245,101,101,.2); color:#F56565; border:1px solid rgba(245,101,101,.3); }
    .stats-container { display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:20px; margin:20px 0; }
    .stat-card { background:rgba(255,255,255,.1); padding:20px; border-radius:10px; text-align:center; }
    .stat-number { font-size:2em; font-weight:700; color:#48BB78; }
    .stat-label { color:#E2E8F0; }
    .users-table th, .users-table td { text-align:center; }
  </style>
</head>
<body>
  <div class="sidebar">
    <h2>Face Recognition</h2>
    <ul>
      <li><a href="lecturer.html">Dashboard</a></li>
      <li><a class="active" href="face_recognition.html">Live Attendance</a></li>
      <li><a href="report.html">Attendance Report</a></li>
    </ul>
    <button class="logout-btn" onclick="window.location.href='index.html'">Logout</button>
  </div>

  <div class="main-content">
    <div class="dashboard-header">
      <h1>Automated Attendance Scanner</h1>
      <p id="moduleInfo">Loading module information...</p>
    </div>

    <div class="stats-container">
      <div class="stat-card">
        <div class="stat-number" id="presentCount">0</div>
        <div class="stat-label">Students Present</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="totalStudents">0</div>
        <div class="stat-label">Total Registered</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="attendanceRate">0%</div>
        <div class="stat-label">Attendance Rate</div>
      </div>
    </div>

    <div class="camera-container">
      <div class="camera-box" id="cameraBox">
        <video id="videoElement" autoplay playsinline muted></video>
        <canvas id="canvas"></canvas>
      </div>

      <div id="statusIndicator" class="status-indicator status-scanning">
        Initializing face system…
      </div>

      <div style="margin-top:12px;">
        <button id="startCamera" class="btn btn-camera btn-start" disabled>Start Scanning</button>
        <button id="stopCamera" class="btn btn-camera btn-stop" disabled>Stop Session</button>
      </div>
    </div>

    <div class="card" style="margin-top: 20px;">
      <h3>Live Attendance Feed</h3>
      <table class="users-table">
        <thead>
          <tr>
            <th>Time</th>
            <th>Student</th>
            <th>Status</th>
            <th>Confidence</th>
          </tr>
        </thead>
        <tbody id="attendanceResults">
          <tr><td colspan="4" style="color:#888;">No attendance recorded yet</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <script defer src="./js/face-api.min.js"></script>
  <script>
    // ====== DOM ======
    const video = document.getElementById('videoElement');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const statusEl = document.getElementById('statusIndicator');
    const startBtn = document.getElementById('startCamera');
    const stopBtn  = document.getElementById('stopCamera');
    const attendanceResults = document.getElementById('attendanceResults');
    const totalStudents = document.getElementById('totalStudents');
    const presentCount = document.getElementById('presentCount');
    const attendanceRate = document.getElementById('attendanceRate');
    const moduleInfo = document.getElementById('moduleInfo');

    // ====== State ======
    let stream = null;
    let loopId = null;
    let sessionActive = false;
    let modelsLoaded = false;
    let matcher = null;
    let labeled = []; 
    const recordedNos = new Set();

    const currentModule = sessionStorage.getItem('currentModule');
    const lecturerName = sessionStorage.getItem('lecturerName');

    if (!currentModule || !lecturerName) {
      alert('Session expired. Start a new session.');
      window.location.href = 'start_session.html';
    }
    moduleInfo.textContent = `Module: ${currentModule} | Lecturer: ${lecturerName}`;

    function setStatus(text, type='scanning') {
      statusEl.textContent = text;
      statusEl.className = `status-indicator status-${type}`;
    }

    // ====== Load Models ======
    async function loadModels() {
      try {
        setStatus('Loading models…', 'scanning');
        await faceapi.nets.tinyFaceDetector.loadFromUri('./models');
        await faceapi.nets.faceLandmark68Net.loadFromUri('./models');
        await faceapi.nets.faceRecognitionNet.loadFromUri('./models');
        modelsLoaded = true;
        setStatus('Models loaded ✓', 'success');
        startBtn.disabled = false;
      } catch (e) {
        setStatus('Failed to load models. Check ./models/ and that you are serving over http(s).', 'error');
      }
    }

    // ====== Load Registered Faces ======
    async function buildLabeledDescriptors() {
      labeled = [];
      const students = JSON.parse(localStorage.getItem('students')) || [];
      const moduleStudents = students.filter(s => Array.isArray(s.modules) && s.modules.includes(currentModule) && s.descriptor);
      totalStudents.textContent = moduleStudents.length;
      if (moduleStudents.length === 0) {
        setStatus('No registered faces for this module. Recognition will show UNKNOWN only.', 'error');
      }
      for (const s of moduleStudents) {
        labeled.push({ student: s, descriptor: new Float32Array(s.descriptor) });
      }
      if (labeled.length > 0) {
        const descriptors = labeled.map(x => new faceapi.LabeledFaceDescriptors(x.student.studentNo, [x.descriptor]));
        matcher = new faceapi.FaceMatcher(descriptors, 0.6);
        setStatus(`Loaded ${labeled.length} labeled face(s).`, 'success');
      } else {
        setStatus('0 labeled faces loaded. Recognition will show UNKNOWN only.', 'error');
      }
    }

    // ====== Camera ======
    async function startCamera() {
      try {
        stream = await navigator.mediaDevices.getUserMedia({ video: { width: 640, height: 480, facingMode: 'user' }, audio:false });
        video.srcObject = stream;
        await video.play();
        canvas.width = video.videoWidth || 640;
        canvas.height = video.videoHeight || 480;
        setStatus('Camera started ✓', 'success');
        return true;
      } catch (e) {
        setStatus('Cannot access camera. Use Chrome/Edge over http(s) and allow permission.', 'error');
        return false;
      }
    }

    function stopCamera() {
      if (stream) stream.getTracks().forEach(t => t.stop());
      stream = null;
      video.srcObject = null;
    }

    // ====== Attendance Save ======
    function saveAttendanceHit(student, confidence) {
      const now = new Date();
      const t = now.toLocaleTimeString();
      const d = now.toLocaleDateString();
      const noRow = attendanceResults.querySelector('td[colspan="4"]');
      if (noRow) noRow.parentElement.remove();
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${t}</td><td>${student.name} (${student.studentNo})</td><td><span style="color:#48BB78;">Present</span></td><td>${(confidence*100).toFixed(1)}%</td>`;
      attendanceResults.prepend(tr);

      const keyMod = currentModule, lec = lecturerName;
      let report = JSON.parse(localStorage.getItem('attendanceReport')) || [];
      let session = report.find(s => s.module===keyMod && s.date===d && s.lecturer===lec);
      if (!session) {
        session = { module:keyMod, lecturer:lec, date:d, startTime:t, students:[] };
        report.push(session);
      }
      session.students.push({
        name: student.name, studentNo: student.studentNo, email: student.email,
        timeRecorded: t, status: 'Present', confidence: (confidence*100).toFixed(1)+'%', autoRecorded: true
      });
      localStorage.setItem('attendanceReport', JSON.stringify(report));

      recordedNos.add(student.studentNo);
      presentCount.textContent = recordedNos.size;
      const total = parseInt(totalStudents.textContent) || 0;
      attendanceRate.textContent = total ? `${((recordedNos.size/total)*100).toFixed(1)}%` : '0%';
    }

    // ====== Loop ======
    async function detectLoop() {
      if (!sessionActive) return;

      const detections = await faceapi.detectAllFaces(video, new faceapi.TinyFaceDetectorOptions({ inputSize: 320, scoreThreshold: 0.35 }))
                                      .withFaceLandmarks()
                                      .withFaceDescriptors();

      ctx.clearRect(0,0,canvas.width, canvas.height);
      setStatus(detections.length ? `Scanning… detected ${detections.length} face(s)` : 'Scanning… waiting for faces', 'scanning');

      for (const det of detections) {
        const { x, y, width, height } = det.detection.box;
        ctx.lineWidth = 2;
        ctx.strokeStyle = '#48BB78';
        ctx.strokeRect(x, y, width, height);

        let label = 'UNKNOWN';
        let conf = 0;

        if (matcher) {
          const best = matcher.findBestMatch(det.descriptor);
          if (best && best.label !== 'unknown') {
            const found = labeled.find(l => l.student.studentNo === best.label);
            if (found) {
              label = found.student.name;
              const d = best.distance; conf = Math.max(0, 1 - d);
              if (!recordedNos.has(found.student.studentNo)) {
                saveAttendanceHit(found.student, conf);
              }
            }
          }
        }

        const pad = 3;
        const txt = `${label}${label==='UNKNOWN' ? '' : ' ✓'}`;
        ctx.fillStyle = label==='UNKNOWN' ? '#F56565' : '#48BB78';
        const textWidth = ctx.measureText(txt).width || (txt.length*7);
        ctx.fillRect(x, y-18, textWidth + 8, 16);
        ctx.fillStyle = '#fff';
        ctx.font = '12px Arial';
        ctx.fillText(txt, x + pad, y - 6);
      }

      loopId = requestAnimationFrame(detectLoop);
    }

    // ====== Buttons ======
    startBtn.addEventListener('click', async () => {
      if (!modelsLoaded) { setStatus('Models not ready yet', 'error'); return; }
      startBtn.disabled = true;
      stopBtn.disabled = false;

      const ok = await startCamera();
      if (!ok) { startBtn.disabled = false; stopBtn.disabled = true; return; }

      await buildLabeledDescriptors();
      sessionActive = true;
      recordedNos.clear();
      presentCount.textContent = '0';
      attendanceRate.textContent = '0%';
      setStatus('Scanning started ✓', 'success');
      loopId = requestAnimationFrame(detectLoop);
    });

    stopBtn.addEventListener('click', () => {
      sessionActive = false;
      if (loopId) cancelAnimationFrame(loopId);
      stopCamera();
      startBtn.disabled = false;
      stopBtn.disabled = true;
      setStatus('Session stopped. Data saved.', 'scanning');
      ctx.clearRect(0,0,canvas.width,canvas.height);
    });

    (async function boot() {
      const waitFaceApi = () => new Promise(res => {
        const check = () => (window.faceapi ? res() : setTimeout(check, 50));
        check();
      });
      await waitFaceApi();
      await loadModels();
    })();

    window.addEventListener('beforeunload', () => {
      sessionActive = false;
      if (loopId) cancelAnimationFrame(loopId);
      stopCamera();
    });
  </script>
</body>
</html>
